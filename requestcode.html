


<script src='./gutil.js'></script>

<center>

	<br> <br> <br> <br>
	<br> <br> <br> <br>

	<img id="qrcode">

	<br><br><br><br>

	<input id="entercode" type="password" size="6" 
		style="font-size:24px;" 
		onkeydown="inputKeyDown(event);"
	>
	&nbsp;
	<button onclick="checkCode();">Ok</button>

	<br><br><br><br>

	<span id="helptext"></span>

</center>


<script>

	let unblockCode = null;
	let pageCode = getParamFromURL("code");
	let numPage = parseInt ( getParamFromURL('np') );

	showQR();


	function showQR() {
		let maintenant = new Date();
		let qrtext = 
			"guexqr:coursinformatique" 
			+ "/" + randomStringAZ09(10)
			+ "/" + getIdBrowser() 
			+ "/" + pageCode 
			+ "/" + maintenant.toISOString()
			+ "/" + randomString09(8)
		;
		unblockCode = Math.abd ( calculateCRC ( qrtext ) % 1000000 );
		unblockCode2 = qrtext.substring ( qrtext.length-5 );

		document.getElementById ( 'qrcode' ).setAttribute ( 
			"src",
			"https://api.qrserver.com/v1/create-qr-code/?size=250x250&data="+qrtext
		);

		document.getElementById ( 'helptext' ).innerHTML = reqtext;

		document.getElementById ( 'entercode' ).value = "";
		document.getElementById ( 'entercode' ).focus();
	}


	function inputKeyDown ( event ) {
		if (event.keyCode == 13) {
			checkCode();
		}
	}


	function checkCode () {
		let valueEntered = document.getElementById("entercode").value;
		console.log ( 'numPage ',numPage );
		console.log ( 'entered '+valueEntered);
		console.log ( 'unblockCode '+unblockCode);
		console.log ( 'moca '+"moca"+(numPage*3));
		if (
			(valueEntered == unblockCode) 
			|| 
			(valueEntered == unblockCode2)
			||
			(valueEntered == "moca"+(numPage*3))
		) {
			console.log ( 'ok!!!');
			let maintenant = new Date();
			console.log ( 'antes ', document.cookie );
			document.cookie = pageCode+"="+maintenant.toISOString()+"-"+valueEntered+"; path=/";
			console.log ( 'depois ', document.cookie );
			//window.parent.location.reload();
		} else {
			console.log ( 'erro...');
			showQR();
		}
	}

</script>

